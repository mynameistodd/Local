<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="stay in tune with local businesses">
    <meta name="author" content="lowecal">
    <meta property="fb:admins" content="21703661" />

    <title>Lowecal - Notifications</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link href="css/landing-page.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- jQuery -->
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    
    <script src="//www.parsecdn.com/js/parse-1.4.0.min.js"></script>

    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxuSUZ7-cXhCDi--yo-XLxy3WtpBHb4bU&v=3.exp&signed_in=true&libraries=places"></script>
    <style>
        #map-canvas {
            height: 100%;
            margin: 0px;
            padding: 0px
        }
    </style>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58721422-1', 'auto');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');

    </script>
</head>

<body>
    <script>
        // Initialize Parse
      Parse.initialize("m5dzHOXkMFC9BHPEbmprX02KM2GoVv2NBBPC5eUN", "UpM6ze97gPhcPWay87crywzruKh6WsAdHIRatem3");

      window.fbAsyncInit = function() {
          Parse.FacebookUtils.init({
              appId      : '1547217908870615',
              status     : true,
              cookie     : true,
              xfbml      : true,
              version    : 'v2.3'
          });
          
          // Run code after the Facebook SDK is loaded.
          var currentUser = Parse.User.current();
          if (!currentUser) {
              window.location.href = "index.html"
          }
      };

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "//connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
    </script>
    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">Lowecal</a>
                <a class="navbar-brand" href="index.html"><img width="30" src="img/lowecal-logo-hat-only.png"></a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <p class="navbar-text navbar-right" id="signedInAs">Signed in as Frank Underwood</p>
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <button type="button" class="btn btn-default navbar-btn" id="logout">Logout</button>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>
    <div class="intro-header-padding">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <div class="alert alert-success" role="alert" style="display:none;">Saved!</div>
                    <div class="alert alert-info" role="alert" style="display:none;">Info!</div>
                    <div class="alert alert-warning" role="alert" style="display:none;">Warning!</div>
                    <div class="alert alert-danger" role="alert" style="display:none;">Error!</div>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <h3 id="placeName">Your Successful Company, Inc.</h3>
                <address id="address">
                    <span>555 Main Street</span>
                    <span>Ann Arbor, MI 48103</span>
                </address>
                <div id="map-canvas" style="height: 200px;"></div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-lg-6">
                <div class="intro-message">
                    <label for="geofenceMessage">New Geofence Message:</label>
                    <div class="input-group input-group-lg">
                        <input id="geofenceMessage" type="text" class="form-control" placeholder="Something to draw in customers nearby">
                        <span class="input-group-btn">
                            <button id="geofenceSave" class="btn btn-default" type="button">Save</button>
                        </span>

                    </div>
                    <small>Currently: </small>
                    <small id="geofenceMessageCurrent">"A catchy phrase to bring in customers."</small>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="intro-message">
                    <label for="pushMessage">Instant Push Notification:</label>
                    <div class="input-group input-group-lg">
                        <input id="pushMessage" type="text" class="form-control" placeholder="Time sensitive message">
                        <span class="input-group-btn">
                            <button id="pushSave" class="btn btn-default" type="button">Send Now</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- /.container -->

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <ul class="list-inline">
                        <li>
                            <a href="index.html">Home</a>
                        </li>
                        <li class="footer-menu-divider">&sdot;</li>
                        <li>
                            <a href="index.html#about">About</a>
                        </li>
                        <li class="footer-menu-divider">&sdot;</li>
                        <li>
                            <a href="index.html#download">Download</a>
                        </li>
                        <li class="footer-menu-divider">&sdot;</li>
                        <li>
                            <a href="index.html#contact">Contact</a>
                        </li>
                    </ul>
                    <p class="copyright text-muted small">Copyright &copy; Lowecal 2015. All Rights Reserved</p>
                </div>
            </div>
        </div>
    </footer>
</body>
    <script type="text/javascript">
        $(document).ready(function() {
            var user = Parse.User.current();
            var channelId = null;
            if (user != null) {
                channelId = user.get("placeId");

                var name = user.get("name");
                $("#signedInAs").text("Signed in as " + name);

                getGeofenceMessage(channelId);

                google.maps.event.addDomListener(window, 'load', initialize(channelId));
            }

            $("#logout").click(function(event){
                Parse.User.logOut();
                window.location.href = "index.html";
            });
            
            $("#geofenceSave").click(function(event) {
                if (user != null && channelId != null) {
                    var geofenceMessageText = $("#geofenceMessage").val();
                    saveGeofenceMessage(channelId, geofenceMessageText);
                }
            });
            
            $("#pushSave").click(function(event) {
                if (user != null && channelId != null) {
                    var pushText = $("#pushMessage").val();
                    
                    Parse.Push.send({
                        channels: [channelId],
                        data: { 
                            alert: pushText
                        }
                    }, {
                        success: function() {
                            console.log("Successfully sent push.");
                            saveMessage(user.id, channelId, pushText);
                        },
                        error: function(error) {
                            console.log(error);
                        }
                    });    
                }
            });

            function initialize(channelId) {
                var request = {
                    placeId: channelId
                };

                var map = new google.maps.Map(document.getElementById('map-canvas'), {
                    center: new google.maps.LatLng(-33.8665433, 151.1956316),
                    zoom: 15
                });

                var infowindow = new google.maps.InfoWindow();
                var service = new google.maps.places.PlacesService(map);

                service.getDetails(request, function(place, status) {

                    if (status == google.maps.places.PlacesServiceStatus.OK) {

                        var marker = new google.maps.Marker({
                            map: map,
                            position: place.geometry.location
                        });
                        google.maps.event.addListener(marker, 'click', function() {
                            infowindow.setContent(place.name);
                            infowindow.open(map, this);
                        });
                        map.setCenter(place.geometry.location);

                        $("#placeName").text(place.name);
                        $("#address").html(place.adr_address);
                    }
                });
            }

            function saveGeofenceMessage(placeId, text) {
                var GeofenceObject = Parse.Object.extend("Geofence");
                var query = new Parse.Query(GeofenceObject);
                query.equalTo("placeId", placeId);
                query.find({
                    success: function(results) {
                        var geofence = new GeofenceObject();

                        if (results.length > 0) {
                            geofence = results[0];
                        } else {
                            geofence.set("placeId", placeId);
                        }

                        geofence.set("text", text);
                        geofence.save(null, {
                            success: function(geofence) {
                                $("#geofenceMessage").val("");
                                $("#geofenceMessageCurrent").text("\"" + text + "\"");
                                $(".alert-success").show();
                                console.log("Saved geofence message.");
                            },
                            error: function(geofence, error) {
                                console.log(error);
                            }
                        });
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            }

            function getGeofenceMessage(placeId) {
                var message = "";

                var GeofenceObject = Parse.Object.extend("Geofence");
                var query = new Parse.Query(GeofenceObject);
                query.equalTo("placeId", placeId);
                query.find({
                    success: function(results) {
                        var geofence = new GeofenceObject();

                        if (results.length > 0) {
                            geofence = results[0];
                            message = geofence.get("text");
                            $("#geofenceMessageCurrent").text("\"" + message + "\"");
                        }
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            }

            function saveMessage(userId, placeId, text) {
                var MessageObject = Parse.Object.extend("Message");
                var message = new MessageObject();
                
                message.set("userId", userId);
                message.set("placeId", placeId);
                message.set("text", text);
                
                message.save(null, {
                    success: function(message) {
                        $("#pushMessage").val("");
                        $(".alert-success").show();
                        console.log("Saved message in history.");
                    },
                    error: function(message, error) {
                        console.log(error);
                    }
                });
            }
        });
    </script>
</html>
